'use strict';exports.__esModule = true;var _regenerator = require('babel-runtime/regenerator');var _regenerator2 = _interopRequireDefault(_regenerator);var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);var _koaRouter = require('koa-router');var _koaRouter2 = _interopRequireDefault(_koaRouter);
var _koaBodyparser = require('koa-bodyparser');var _koaBodyparser2 = _interopRequireDefault(_koaBodyparser);
var _exception = require('../middlewares/exception');var _exception2 = _interopRequireDefault(_exception);
var _data = require('../models/data');
var _schemas = require('../models/schemas');
var _faker = require('../utils/faker');var _faker2 = _interopRequireDefault(_faker);
var _objectId = require('../utils/objectId');function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { default: obj };}

var router = new _koaRouter2.default();
router.use(_exception2.default);

var DB = 'data';

router.get('/data/:schema/:page/:size', function () {var _ref = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee(ctx) {var _ctx$params, schema, _ctx$params$page, page, _ctx$params$size, size, data;return _regenerator2.default.wrap(function _callee$(_context) {while (1) {switch (_context.prev = _context.next) {case 0:_ctx$params =
            ctx.params, schema = _ctx$params.schema, _ctx$params$page = _ctx$params.page, page = _ctx$params$page === undefined ? 1 : _ctx$params$page, _ctx$params$size = _ctx$params.size, size = _ctx$params$size === undefined ? 20 : _ctx$params$size;_context.next = 3;return (
              (0, _data.getPageList)(
              ctx.db(DB).collection(schema),
              ctx.query,
              parseInt(page, 10),
              parseInt(size, 10)));case 3:data = _context.sent;

            ctx.Render.success(data);case 5:case 'end':return _context.stop();}}}, _callee, undefined);}));return function (_x) {return _ref.apply(this, arguments);};}());


router.post('/data/:schema', (0, _koaBodyparser2.default)(), function () {var _ref2 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee2(ctx) {var data, schema;return _regenerator2.default.wrap(function _callee2$(_context2) {while (1) {switch (_context2.prev = _context2.next) {case 0:
            data = ctx.request.body;
            schema = ctx.params.schema;_context2.next = 4;return (

              (0, _data.insertOrUpdate)(ctx.db(DB), schema, data));case 4:data = _context2.sent;

            ctx.Render.success(data[0]);case 6:case 'end':return _context2.stop();}}}, _callee2, undefined);}));return function (_x2) {return _ref2.apply(this, arguments);};}());


router.del('/data/:schema', (0, _koaBodyparser2.default)(), function () {var _ref3 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee3(ctx) {var query, col, count;return _regenerator2.default.wrap(function _callee3$(_context3) {while (1) {switch (_context3.prev = _context3.next) {case 0:
            query = ctx.request.body;
            col = ctx.db(DB).collection(ctx.params.schema);_context3.next = 4;return (
              (0, _data.remove)(col, query._id));case 4:count = _context3.sent;
            ctx.Render.success(count);case 6:case 'end':return _context3.stop();}}}, _callee3, undefined);}));return function (_x3) {return _ref3.apply(this, arguments);};}());


router.del('/data/:schema/all', (0, _koaBodyparser2.default)(), function () {var _ref4 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee4(ctx) {var col, count;return _regenerator2.default.wrap(function _callee4$(_context4) {while (1) {switch (_context4.prev = _context4.next) {case 0:
            col = ctx.db(DB).collection(ctx.params.schema);_context4.next = 3;return (
              (0, _data.remove)(col, {}));case 3:count = _context4.sent;
            ctx.Render.success(count);case 5:case 'end':return _context4.stop();}}}, _callee4, undefined);}));return function (_x4) {return _ref4.apply(this, arguments);};}());


router.post('/data/:code/mockcreate/:count', function () {var _ref5 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee5(ctx) {var _ctx$params2, code, count, schema, data, i, model;return _regenerator2.default.wrap(function _callee5$(_context5) {while (1) {switch (_context5.prev = _context5.next) {case 0:_ctx$params2 =
            ctx.params, code = _ctx$params2.code, count = _ctx$params2.count;_context5.next = 3;return (
              (0, _schemas.getOne)(ctx.db(), { code: code }));case 3:schema = _context5.sent;if (
            schema) {_context5.next = 7;break;}
            ctx.Render.fail('schema not found.');return _context5.abrupt('return');case 7:



            data = [];

            i = 0;case 9:if (!(i < parseInt(count || 10, 10))) {_context5.next = 20;break;}_context5.next = 12;return (
              (0, _faker2.default)(schema.fields, ctx.db(DB), _data.getPageList));case 12:model = _context5.sent;_context5.next = 15;return (
              (0, _objectId.nextSequence)(code));case 15:model._id = _context5.sent;
            data.push(model);case 17:i++;_context5.next = 9;break;case 20:


            (0, _data.insert)(ctx.db(DB).collection(code), data);
            ctx.Render.success('');case 22:case 'end':return _context5.stop();}}}, _callee5, undefined);}));return function (_x5) {return _ref5.apply(this, arguments);};}());


router.get('/data/:code/getmock', function () {var _ref6 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee6(ctx) {var code, schema, data;return _regenerator2.default.wrap(function _callee6$(_context6) {while (1) {switch (_context6.prev = _context6.next) {case 0:
            code = ctx.params.code;_context6.next = 3;return (

              (0, _schemas.getOne)(ctx.db(), { code: code }));case 3:schema = _context6.sent;if (
            schema) {_context6.next = 7;break;}
            ctx.Render.fail('schema not found.');return _context6.abrupt('return');case 7:_context6.next = 9;return (



              (0, _faker2.default)(schema.fields, ctx.db(DB), _data.getPageList));case 9:data = _context6.sent;
            ctx.Render.success(data);case 11:case 'end':return _context6.stop();}}}, _callee6, undefined);}));return function (_x6) {return _ref6.apply(this, arguments);};}());exports.default =


router;
//# sourceMappingURL=data.js.map