'use strict';exports.__esModule = true;var _assign = require('babel-runtime/core-js/object/assign');var _assign2 = _interopRequireDefault(_assign);var _objectWithoutProperties2 = require('babel-runtime/helpers/objectWithoutProperties');var _objectWithoutProperties3 = _interopRequireDefault(_objectWithoutProperties2);var _regenerator = require('babel-runtime/regenerator');var _regenerator2 = _interopRequireDefault(_regenerator);var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);var _koaRouter = require('koa-router');var _koaRouter2 = _interopRequireDefault(_koaRouter);
var _koaBodyparser = require('koa-bodyparser');var _koaBodyparser2 = _interopRequireDefault(_koaBodyparser);
var _api = require('../models/api');
var _objectId = require('../utils/objectId');var _objectId2 = _interopRequireDefault(_objectId);
var _exception = require('../middlewares/exception');var _exception2 = _interopRequireDefault(_exception);function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { default: obj };}

var router = new _koaRouter2.default();

router.use(_exception2.default);

router.get('/api', function () {var _ref = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee(ctx) {var data;return _regenerator2.default.wrap(function _callee$(_context) {while (1) {switch (_context.prev = _context.next) {case 0:_context.next = 2;return (
              (0, _api.getAll)(ctx.db()));case 2:data = _context.sent;
            ctx.Render.success(data);case 4:case 'end':return _context.stop();}}}, _callee, undefined);}));return function (_x) {return _ref.apply(this, arguments);};}());


router.get('/api/:id', function () {var _ref2 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee2(ctx) {var data;return _regenerator2.default.wrap(function _callee2$(_context2) {while (1) {switch (_context2.prev = _context2.next) {case 0:_context2.next = 2;return (
              (0, _api.getOne)(ctx.db(), { _id: (0, _objectId2.default)(ctx.params.id) }));case 2:data = _context2.sent;
            if (data) {
              ctx.Render.success(data);
            } else {
              ctx.Render.notFound();
            }case 4:case 'end':return _context2.stop();}}}, _callee2, undefined);}));return function (_x2) {return _ref2.apply(this, arguments);};}());


router.post('/api', (0, _koaBodyparser2.default)(), function () {var _ref3 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee3(ctx) {var _ctx$request$body, _id, data, method, db, query, old, existed;return _regenerator2.default.wrap(function _callee3$(_context3) {while (1) {switch (_context3.prev = _context3.next) {case 0:_ctx$request$body =
            ctx.request.body, _id = _ctx$request$body._id, data = (0, _objectWithoutProperties3.default)(_ctx$request$body, ['_id']);

            method = _id ? _api.updateApi : _api.insertApi;
            db = ctx.db();
            query = { route: data.route, method: data.method };if (!

            _id) {_context3.next = 13;break;}
            _id = (0, _objectId2.default)(_id);_context3.next = 8;return (
              (0, _api.getOne)(db, { _id: _id }));case 8:old = _context3.sent;
            data = (0, _assign2.default)({}, old, data);
            query._id = { $ne: _id };_context3.next = 15;break;case 13:

            data.status = 1;
            data.createAt = Date.now();case 15:


            data.weight = parseInt(data.weight || 0, 10);_context3.next = 18;return (

              (0, _api.getOne)(db, query));case 18:existed = _context3.sent;if (!
            existed) {_context3.next = 22;break;}
            ctx.Render.fail('\u8DEF\u5F84 \'' + data.route + '\' ' + data.method + ' \u65B9\u6CD5\u5DF2\u7ECF\u5B58\u5728');return _context3.abrupt('return');case 22:



            data.updateAt = Date.now();_context3.next = 25;return (

              method(db, data));case 25:data = _context3.sent;

            ctx.Render.success(data[0]);case 27:case 'end':return _context3.stop();}}}, _callee3, undefined);}));return function (_x3) {return _ref3.apply(this, arguments);};}());


router.post('/api/toggle', (0, _koaBodyparser2.default)(), function () {var _ref4 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee4(ctx) {var _ctx$request$body2, _id, status, db, model;return _regenerator2.default.wrap(function _callee4$(_context4) {while (1) {switch (_context4.prev = _context4.next) {case 0:_ctx$request$body2 =
            ctx.request.body, _id = _ctx$request$body2._id, status = _ctx$request$body2.status;
            db = ctx.db();_context4.next = 4;return (
              (0, _api.getOne)(db, { _id: (0, _objectId2.default)(_id) }));case 4:model = _context4.sent;
            if (!model) ctx.Render.notFound();

            model.status = status;_context4.next = 9;return (
              (0, _api.updateApi)(db, model));case 9:
            ctx.Render.success(1);case 10:case 'end':return _context4.stop();}}}, _callee4, undefined);}));return function (_x4) {return _ref4.apply(this, arguments);};}());


router.del('/api', (0, _koaBodyparser2.default)(), function () {var _ref5 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee5(ctx) {var data, count;return _regenerator2.default.wrap(function _callee5$(_context5) {while (1) {switch (_context5.prev = _context5.next) {case 0:
            data = ctx.request.body;_context5.next = 3;return (
              (0, _api.removeApi)(ctx.db(), data._id));case 3:count = _context5.sent;
            ctx.Render.success(count);case 5:case 'end':return _context5.stop();}}}, _callee5, undefined);}));return function (_x5) {return _ref5.apply(this, arguments);};}());exports.default =


router;
//# sourceMappingURL=api.js.map