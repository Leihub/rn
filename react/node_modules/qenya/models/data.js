'use strict';exports.__esModule = true;exports.insertOrUpdate = undefined;var _assign = require('babel-runtime/core-js/object/assign');var _assign2 = _interopRequireDefault(_assign);var _objectWithoutProperties2 = require('babel-runtime/helpers/objectWithoutProperties');var _objectWithoutProperties3 = _interopRequireDefault(_objectWithoutProperties2);var _regenerator = require('babel-runtime/regenerator');var _regenerator2 = _interopRequireDefault(_regenerator);var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);var _promise = require('babel-runtime/core-js/promise');var _promise2 = _interopRequireDefault(_promise);var insertOrUpdate = exports.insertOrUpdate = function () {var _ref3 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(






























































  function _callee3(db, schema, data) {var _data, _id, params, method, old;return _regenerator2.default.wrap(function _callee3$(_context3) {while (1) {switch (_context3.prev = _context3.next) {case 0:_data =
            data, _id = _data._id, params = (0, _objectWithoutProperties3.default)(_data, ['_id']);
            method = _id ? update : insert;if (!

            _id) {_context3.next = 9;break;}_context3.next = 5;return (
              getOne(db.collection(schema), { _id: parseInt(_id, 10) }));case 5:old = _context3.sent;
            data = (0, _assign2.default)({}, old, params);_context3.next = 12;break;case 9:_context3.next = 11;return (

              (0, _objectId.nextSequence)(schema));case 11:data._id = _context3.sent;case 12:return _context3.abrupt('return',


            method(db.collection(schema), data));case 13:case 'end':return _context3.stop();}}}, _callee3, this);}));return function insertOrUpdate(_x11, _x12, _x13) {return _ref3.apply(this, arguments);};}();exports.getPageList = getPageList;exports.getList = getList;exports.insert = insert;exports.update = update;exports.getOne = getOne;exports.


remove = remove;var _model = require('../utils/model');var _objectId = require('../utils/objectId');var _config = require('../config');var _config2 = _interopRequireDefault(_config);function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { default: obj };}function getCount(col, query) {return new _promise2.default(function () {col.find(query).count(_model.callback.apply(undefined, arguments));});}function getPageList(col) {var query = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};var page = arguments[2];var _this = this;var size = arguments[3];var sort = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : { _id: -1 };return new _promise2.default(function () {var _ref = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee(resolve, reject) {var total;return _regenerator2.default.wrap(function _callee$(_context) {while (1) {switch (_context.prev = _context.next) {case 0:_context.next = 2;return getCount(col, query);case 2:total = _context.sent;col.find(query).sort(sort).skip((page - 1) * size).limit(size).toArray(function (err, list) {if (err) {reject(err);} else {resolve({ total: total, page: page, size: size, list: list });}});case 4:case 'end':return _context.stop();}}}, _callee, _this);}));return function (_x3, _x4) {return _ref.apply(this, arguments);};}());}function getList(col) {var query = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};var page = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 1;var _this2 = this;var size = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 10;var sort = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : { _id: -1 };return new _promise2.default(function () {var _ref2 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee2(resolve, reject) {return _regenerator2.default.wrap(function _callee2$(_context2) {while (1) {switch (_context2.prev = _context2.next) {case 0:col.find(query).sort(sort).skip((page - 1) * size).limit(size).toArray(function (err, list) {if (err) {reject(err);} else {resolve(list);}});case 1:case 'end':return _context2.stop();}}}, _callee2, _this2);}));return function (_x9, _x10) {return _ref2.apply(this, arguments);};}());}function insert(col, model) {return new _promise2.default(function (resolve, reject) {col.insert(model, function (err, result) {if (err) reject(err);if (_config2.default.engine === 'tingodb') resolve(result);else resolve(result.ops);});});}function update(col, model) {return new _promise2.default(function (resolve, reject) {col.update({ _id: model._id }, { $set: model }, function (err) {if (err) reject(err);else resolve([model]);});});}function getOne(col, query) {return new _promise2.default(function () {col.findOne(query, _model.callback.apply(undefined, arguments));});}function remove(col, query) {
  if (typeof query === 'string') query = { _id: query };
  return new _promise2.default(function (resolve, reject) {
    col.remove(query, function (err, result) {
      if (err) reject(err);
      if (_config2.default.engine === 'tingodb') resolve(result);else
      resolve(result.result.ok);
    });
  });
}
//# sourceMappingURL=data.js.map